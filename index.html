<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GastroManager Safe</title>
    
    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fade-in 0.5s ease-out forwards; }
    </style>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc, onSnapshot, query, orderBy, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { Thermometer, Droplet, ClipboardList, Settings, LogOut, Plus, Trash2, User, CheckCircle, AlertOctagon, Snowflake, Loader2, Save, ShoppingCart, Wrench, Truck, Menu, X, Sparkles, ChefHat, Coffee, AlertTriangle, Siren, Ban, Calendar, Edit3, ChevronDown, ChevronUp, ArrowRight, PlayCircle, StopCircle, Bug } from "https://esm.sh/lucide-react@0.294.0?deps=react@18.2.0";

        const { useState, useEffect, useRef } = React;

        // --- DEINE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyDkmhRTKaRI2qPcnSvkiH4CETnrOu98zyk",
          authDomain: "gastromaster-209db.firebaseapp.com",
          projectId: "gastromaster-209db",
          storageBucket: "gastromaster-209db.firebasestorage.app",
          messagingSenderId: "128839756122",
          appId: "1:128839756122:web:c717afecc8bf6f0b8ceb63",
          measurementId: "G-FZ2F4CZGR8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'gastro-safe-v1'; // Stabiler Namespace

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) return <div className="p-10 text-red-600 text-center"><h1>Kritischer Fehler</h1><p>{this.state.error.toString()}</p><button onClick={()=>window.location.reload()} className="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Neustart</button></div>;
                return this.props.children;
            }
        }

        // --- COMPONENTS ---
        const NavBtn = ({icon, label, active, onClick}) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 px-2 py-2 rounded-xl transition-all ${active?'text-indigo-600 bg-indigo-50 scale-110':'text-slate-400'}`}>{React.cloneElement(icon,{size:22,strokeWidth:active?2.5:2})}<span className="text-[9px] font-bold">{label}</span></button>
        );

        const MenuCard = ({ title, sub, icon, color, onClick, badge }) => (
            <button onClick={onClick} className={`bg-gradient-to-br ${color} p-4 rounded-2xl shadow-lg text-white text-left relative overflow-hidden active:scale-95 transition-all w-full`}>
                <div className="relative z-10"><div className="mb-2 opacity-90 p-1 bg-white/20 rounded w-fit">{icon}</div><div className="font-black text-lg leading-none">{title}</div><div className="text-[10px] opacity-80 font-bold uppercase mt-1">{sub}</div></div>
                {badge > 0 && <div className="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-pulse">{badge}</div>}
            </button>
        );

        // --- MAIN APP ---
        function App() {
            const [user, setUser] = useState(null);
            const [appUser, setAppUser] = useState(null);
            const [view, setView] = useState('login');
            const [loading, setLoading] = useState(true);
            const [dbError, setDbError] = useState(null); // Neuer Status für DB Fehler
            
            // Data
            const [data, setData] = useState({ staff: [], cooling: [], fryers: [], tasks: [], suppliers: [] });
            const [status, setStatus] = useState({ tempLogs: [], activeShifts: {}, oilLogs: {}, cleaningLogs: {}, shoppingList: [] });

            // Auth
            useEffect(() => {
                signInAnonymously(auth).catch(e => setDbError("Auth Fehler: " + e.message));
                return onAuthStateChanged(auth, u => { setUser(u); if(!u) setLoading(false); });
            }, []);

            // Data Listener (ABGESICHERT)
            useEffect(() => {
                if (!user) return;
                const pub = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);
                const today = new Date().toISOString().slice(0, 10);

                // Helper für sicheres Laden
                const safeSub = (colName, callback) => {
                    return onSnapshot(pub(colName), 
                        (snap) => callback(snap.docs.map(d => ({id: d.id, ...d.data()}))),
                        (err) => {
                            console.error(`Fehler bei ${colName}:`, err);
                            if (err.code === 'permission-denied') {
                                setDbError("ZUGRIFF VERWEIGERT: Deine Datenbank ist gesperrt (Rules).");
                            }
                        }
                    );
                };

                // Master Data
                const unsubs = [
                    safeSub('staff', (list) => { setData(p => ({...p, staff: list})); setLoading(false); }),
                    safeSub('cooling_devices', l => setData(p => ({...p, cooling: l}))),
                    safeSub('fryers', l => setData(p => ({...p, fryers: l}))),
                    safeSub('cleaning_tasks', l => setData(p => ({...p, tasks: l}))),
                    safeSub('suppliers', l => setData(p => ({...p, suppliers: l}))),
                    
                    // Live Data (Filter im Client)
                    safeSub('logs_temp', l => setStatus(p => ({...p, tempLogs: l.filter(x => x.dateStr === today)}))),
                    safeSub('logs_cleaning', l => {
                        const map = {}; l.filter(x => x.dateStr === today).forEach(x => map[x.taskId] = x);
                        setStatus(p => ({...p, cleaningLogs: map}));
                    }),
                    safeSub('logs_time', l => {
                        const map = {}; l.filter(x => !x.end).forEach(x => map[x.userId] = {id: x.id, ...x});
                        setStatus(p => ({...p, activeShifts: map}));
                    })
                ];

                return () => unsubs.forEach(u => u());
            }, [user]);

            // Seed
            const seed = async () => {
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), { name: 'Chef', role: 'admin', departments: ['kitchen', 'service'], pin: '0000', createdAt: serverTimestamp() });
                    alert("Admin erstellt!");
                } catch(e) { alert("Fehler: " + e.message); }
            };

            // Views
            if (dbError) return (
                <div className="h-screen flex flex-col items-center justify-center p-6 bg-slate-900 text-white text-center">
                    <AlertTriangle size={48} className="text-red-500 mb-4"/>
                    <h2 className="text-xl font-bold mb-2">Datenbank Zugriff Verweigert</h2>
                    <p className="text-sm text-slate-400 mb-4">Die Firebase Sicherheitsregeln blockieren den Zugriff.</p>
                    <div className="bg-slate-800 p-4 rounded-xl text-left text-xs font-mono text-green-400 overflow-auto w-full max-w-md">
                        <p className="text-slate-500 mb-2">// Gehe in die Firebase Console -> Firestore -> Rules und füge ein:</p>
                        match /artifacts/&#123;appId&#125;/public/data/&#123;document=**&#125; &#123;<br/>
                        &nbsp;&nbsp;allow read, write: if true;<br/>
                        &#125;
                    </div>
                    <button onClick={() => window.location.reload()} className="mt-6 bg-indigo-600 px-6 py-2 rounded-full font-bold">Seite neu laden</button>
                </div>
            );

            if (loading) return <div className="h-screen bg-slate-900 flex items-center justify-center text-white"><Loader2 className="animate-spin" size={40}/></div>;

            if (!appUser) return (
                <div className="h-screen bg-slate-900 flex flex-col items-center justify-center p-6">
                    <h1 className="text-4xl font-black text-white italic mb-8">GASTRO<span className="text-indigo-500">.SAFE</span></h1>
                    <div className="space-y-3 w-full max-w-sm">
                        {data.staff.map(s => (
                            <button key={s.id} onClick={() => {setAppUser(s); setView('dashboard')}} className="w-full bg-white/10 p-4 rounded-xl text-white font-bold flex gap-4 items-center hover:bg-indigo-600 transition-colors">
                                <User/> {s.name}
                            </button>
                        ))}
                        {data.staff.length === 0 && <button onClick={seed} className="w-full py-4 border border-dashed border-slate-600 text-slate-400 rounded-xl">Datenbank Initialisieren</button>}
                    </div>
                </div>
            );

            const hasAccess = (dept) => (appUser.role === 'admin' || (appUser.departments||[]).includes(dept));

            return (
                <div className="min-h-screen bg-slate-50 pb-24 font-sans text-slate-800">
                    <div className="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow flex justify-between items-center rounded-b-2xl">
                        <span className="font-black italic">GASTRO<span className="text-indigo-400">.SAFE</span></span>
                        <div className="flex gap-2 items-center"><span className="text-xs opacity-50">{appUser.name}</span><button onClick={()=>setAppUser(null)}><LogOut size={16}/></button></div>
                    </div>

                    <div className="max-w-xl mx-auto p-4 space-y-4">
                        {view === 'dashboard' && (
                            <div className="grid grid-cols-2 gap-3">
                                <MenuCard title="Putzplan" sub="Check" icon={<Sparkles/>} color="from-indigo-500 to-violet-600" onClick={()=>setView('cleaning')}/>
                                <MenuCard title="Kühlung" sub="Temp" icon={<Snowflake/>} color="from-cyan-500 to-blue-600" onClick={()=>setView('cooling')}/>
                                {hasAccess('kitchen') && <MenuCard title="Fett" sub="Öl" icon={<Droplet/>} color="from-orange-400 to-red-500" onClick={()=>setView('oil')}/>}
                                {appUser.role==='admin' && <MenuCard title="Admin" sub="Setup" icon={<Settings/>} color="from-slate-600 to-slate-800" onClick={()=>setView('admin')}/>}
                            </div>
                        )}
                        
                        {view === 'cooling' && <SimpleList items={data.cooling} logs={status.tempLogs} user={appUser} appId={appId} col="logs_temp" unit="°C"/>}
                        {view === 'oil' && <OilList items={data.fryers} appId={appId} user={appUser}/>} 
                        {view === 'cleaning' && <CleaningList tasks={data.tasks} logs={status.cleaningLogs} user={appUser} appId={appId}/>}
                        
                        {view === 'admin' && (
                            <div className="bg-white p-4 rounded-xl shadow border">
                                <h3 className="font-bold mb-4">Neuen Mitarbeiter anlegen</h3>
                                <div className="flex gap-2">
                                    <input id="newStaff" placeholder="Name" className="flex-1 border p-2 rounded"/>
                                    <button onClick={async()=>{
                                        const n = document.getElementById('newStaff').value;
                                        if(n) await addDoc(collection(db,'artifacts',appId,'public','data','staff'),{name:n, departments:['kitchen'], role:'user'});
                                        alert('Angelegt');
                                    }} className="bg-indigo-600 text-white px-4 rounded">Save</button>
                                </div>
                            </div>
                        )}
                    </div>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t p-2 flex justify-around pb-6 z-40">
                        <NavBtn icon={<Menu/>} label="Home" active={view==='dashboard'} onClick={()=>setView('dashboard')}/>
                        <NavBtn icon={<Sparkles/>} label="Putz" active={view==='cleaning'} onClick={()=>setView('cleaning')}/>
                        <NavBtn icon={<Thermometer/>} label="Kühl" active={view==='cooling'} onClick={()=>setView('cooling')}/>
                    </nav>
                </div>
            );
        }

        // --- SUB COMPONENTS (Vereinfacht) ---
        const SimpleList = ({items, logs, user, appId, col, unit}) => (
            <div className="space-y-3">{items.map(i => {
                const done = logs.find(l => l.deviceId === i.id);
                return <div key={i.id} className="bg-white p-3 rounded-xl border flex justify-between items-center shadow-sm">
                    <span className="font-bold">{i.name}</span>
                    {done ? <span className="text-green-600 font-bold">{done.temp}{unit}</span> : 
                    <div className="flex gap-1"><input id={`v-${i.id}`} type="number" className="w-16 border rounded text-center" placeholder={unit}/>
                    <button onClick={async()=>{const v=document.getElementById(`v-${i.id}`).value; if(v) await addDoc(collection(db,'artifacts',appId,'public','data',col),{deviceId:i.id, deviceName:i.name, temp:v, user:user.name, dateStr: new Date().toISOString().slice(0,10)})}} className="bg-slate-900 text-white px-2 rounded">OK</button></div>}
                </div>
            })}</div>
        );

        const CleaningList = ({tasks, logs, user, appId}) => (
            <div className="space-y-3">{tasks.map(t => {
                const done = logs[t.id];
                return <div key={t.id} onClick={async()=>{
                    const ref = doc(db,'artifacts',appId,'public','data','logs_cleaning',`${new Date().toISOString().slice(0,10)}_${t.id}`);
                    if(!done) await setDoc(ref, {taskId:t.id, taskName:t.name, user:user.name, dateStr:new Date().toISOString().slice(0,10)});
                }} className={`p-4 rounded-xl border flex justify-between items-center cursor-pointer ${done?'bg-green-50 border-green-200':'bg-white'}`}>
                    <span className={done?'line-through opacity-50 font-bold':'font-bold'}>{t.name}</span>
                    {done && <CheckCircle className="text-green-500" size={20}/>}
                </div>
            })}</div>
        );

        const OilList = ({items, appId, user}) => (
            <div className="space-y-3">{items.map(i => (
                <div key={i.id} className="bg-white p-4 rounded-xl border shadow-sm">
                    <div className="font-bold mb-2">{i.name}</div>
                    <div className="flex gap-2">
                        <input id={`t-${i.id}`} placeholder="Temp" className="flex-1 border p-2 rounded"/>
                        <input id={`p-${i.id}`} placeholder="TPM" className="flex-1 border p-2 rounded"/>
                        <button onClick={async()=>{
                            const t = document.getElementById(`t-${i.id}`).value;
                            const p = document.getElementById(`p-${i.id}`).value;
                            if(t&&p) await addDoc(collection(db,'artifacts',appId,'public','data','logs_oil'),{deviceId:i.id, temp:t, tpm:p, user:user.name, createdAt: new Date()});
                        }} className="bg-slate-900 text-white px-3 rounded"><Save size={18}/></button>
                    </div>
                </div>
            ))}</div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
