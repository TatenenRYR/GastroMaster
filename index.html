<!DOCTYPE html>
<html lang="de" class="h-full bg-slate-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GastroManager Platinum v2.1</title>
    
    <!-- Styles & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        /* Mobile Optimierungen */
        :root { --sat: env(safe-area-inset-top); --sab: env(safe-area-inset-bottom); }
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: var(--sab); }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animationen */
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fade-in-up 0.4s ease-out forwards; }
        .safe-bottom { padding-bottom: calc(80px + var(--sab)); }
        
        /* Bessere Touch-Ziele auf Mobile */
        input, select, button { touch-action: manipulation; }
    </style>

    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="h-full">
    <div id="root" class="h-full"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, deleteDoc, doc, setDoc, updateDoc,
            onSnapshot, query, orderBy, limit, serverTimestamp, where 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            Thermometer, Droplet, ClipboardList, Settings, LogOut, 
            Plus, Trash2, User, CheckCircle, AlertOctagon, Snowflake, 
            Loader2, Save, ShoppingCart, Wrench, Truck, 
            Menu, X, Sparkles, ChefHat, Coffee, AlertTriangle, Siren, Ban,
            Calendar, Edit3, ChevronDown, ChevronUp, ArrowRight, PlayCircle, StopCircle,
            Bug, Terminal, Eraser, Power, CheckSquare, Database
        } from "https://esm.sh/lucide-react@0.294.0?deps=react@18.2.0";

        const { useState, useEffect, useRef, useMemo } = React;

        // --- 1. CONFIG & UTILS ---
        const firebaseConfig = {
          apiKey: "AIzaSyDkmhRTKaRI2qPcnSvkiH4CETnrOu98zyk",
          authDomain: "gastromaster-209db.firebaseapp.com",
          projectId: "gastromaster-209db",
          storageBucket: "gastromaster-209db.firebasestorage.app",
          messagingSenderId: "128839756122",
          appId: "1:128839756122:web:c717afecc8bf6f0b8ceb63",
          measurementId: "G-FZ2F4CZGR8"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error("Init Error", e); }
        const appId = 'gastro-debug-v2'; 

        const getTodayStr = () => new Date().toISOString().slice(0, 10);
        const getWeekdayShort = () => ['So','Mo','Di','Mi','Do','Fr','Sa'][new Date().getDay()];
        
        const getTempStatus = (temp) => {
            if (!temp && temp !== 0) return 'neutral';
            const t = parseFloat(temp);
            if (t < 0 || t > 8) return 'danger'; 
            if (t >= 0 && t <= 8) return 'ok';
            return 'neutral';
        };

        // --- 2. SHARED COMPONENTS ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            render() { if (this.state.hasError) return <div className="p-8 text-center text-red-600 font-bold mt-20">Ein Fehler ist aufgetreten. Bitte App neu laden.</div>; return this.props.children; }
        }

        const LoadingSpinner = ({ color = 'text-indigo-500' }) => <Loader2 className={`animate-spin ${color}`} size={24} />;
        
        const Header = ({ title, sub }) => (
            <div className="mb-5 pt-2">
                <h2 className="text-2xl font-black text-slate-800 tracking-tight leading-none">{title}</h2>
                {sub && <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mt-1">{sub}</p>}
            </div>
        );

        const Input = (props) => <input {...props} className={`w-full p-3.5 rounded-xl border border-slate-200 bg-white text-base font-medium focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all ${props.className || ''}`} />;
        const Select = (props) => <select {...props} className={`w-full p-3.5 rounded-xl border border-slate-200 bg-white text-base font-medium appearance-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all bg-[url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%20class%3D%22feather%20feather-chevron-down%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E')] bg-[length:20px] bg-no-repeat bg-[right_12px_center] pr-10 ${props.className || ''}`}>{props.children}</select>;
        const Button = ({ children, isLoading, variant='primary', onClick, className='' }) => {
             const base = "w-full py-3.5 rounded-xl font-bold text-sm uppercase tracking-wider flex justify-center items-center gap-2 transition-all active:scale-[0.98]";
             const variants = {
                 primary: "bg-slate-900 text-white shadow-md hover:bg-slate-800 disabled:bg-slate-400",
                 danger: "bg-red-50 text-red-600 hover:bg-red-100",
                 ghost: "bg-transparent text-slate-500 hover:bg-slate-100 border"
             };
             return <button onClick={onClick} disabled={isLoading} className={`${base} ${variants[variant]} ${className}`}>{isLoading ? <Loader2 className="animate-spin" size={20}/> : children}</button>
        };

        const Toast = ({ msg, type }) => (
            <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[100] px-6 py-3 rounded-full shadow-2xl font-bold text-sm animate-in flex items-center gap-3 border ${type==='error'?'bg-red-50 border-red-100 text-red-600':'bg-emerald-50 border-emerald-100 text-emerald-700'}`}>
                {type==='error' ? <AlertTriangle size={18}/> : <CheckCircle size={18}/>} {msg}
            </div>
        );

        /* --- 3. MAIN APP SHELL --- */
        function App() {
            const [user, setUser] = useState(null);
            const [appUser, setAppUser] = useState(null);
            const [view, setView] = useState('login'); 
            const [loading, setLoading] = useState(true);
            const [toast, setToast] = useState(null);
            const [seeding, setSeeding] = useState(false);
            const [data, setData] = useState({ staff: [], cooling: [], fryers: [], tasks: [] });
            const [status, setStatus] = useState({ tempLogs: [], cleaningLogs: {}, oilLogs: {}, shoppingList: [] });

            const showToast = (msg, type='success') => { setToast({msg, type}); setTimeout(() => setToast(null), 2500); };

            useEffect(() => {
                if (!app) return;
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, u => { setUser(u); if(!u) setLoading(false); });
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const pub = (c) => collection(db, 'artifacts', appId, 'public', 'data', c);
                
                ['staff', 'cooling_devices', 'fryers', 'cleaning_tasks'].forEach(c => 
                    onSnapshot(query(pub(c), orderBy('name')), s => {
                        const key = c === 'cooling_devices' ? 'cooling' : c === 'cleaning_tasks' ? 'tasks' : c;
                        setData(p => ({ ...p, [key]: s.docs.map(d => ({ id: d.id, ...d.data() })) }));
                        if(c==='staff') setLoading(false);
                    })
                );

                const today = getTodayStr();
                onSnapshot(query(pub('logs_temp'), where('dateStr', '==', today)), s => setStatus(p => ({...p, tempLogs: s.docs.map(d=>d.data())})));
                onSnapshot(query(pub('logs_cleaning'), where('dateStr', '==', today)), s => {
                    const logs = {}; s.docs.forEach(d => logs[d.data().taskId] = d.data());
                    setStatus(p => ({...p, cleaningLogs: logs}));
                });
                onSnapshot(query(pub('logs_oil'), orderBy('createdAt', 'desc'), limit(10)), s => {
                    const latest = {}; s.docs.forEach(d => { if(!latest[d.data().deviceId]) latest[d.data().deviceId] = d.data(); });
                    setStatus(p => ({...p, oilLogs: latest}));
                });
                onSnapshot(pub('shopping_list_manual'), s => setStatus(p => ({...p, shoppingList: s.docs.map(d=>({...d.data(), id:d.id}))})));
            }, [user]);

            // --- SEED FUNCTION FOR EMPTY DB ---
            const seedDatabase = async () => {
                setSeeding(true);
                try {
                    // Erstelle Admin
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'staff'), { 
                        name: 'Chef', 
                        role: 'admin', 
                        departments: ['kitchen', 'service'], 
                        pin: '0000', 
                        createdAt: serverTimestamp() 
                    });
                    // Erstelle ein Beispiel-Gerät
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'cooling_devices'), { 
                        name: 'Kühlschrank 1', 
                        status: 'active',
                        createdAt: serverTimestamp() 
                    });
                    showToast("System eingerichtet! Bitte einloggen.");
                } catch(e) {
                    showToast("Fehler beim Einrichten", "error");
                    console.error(e);
                }
                setSeeding(false);
            };

            if (loading) return <div className="h-full flex items-center justify-center"><LoadingSpinner size={40}/></div>;
            if (!appUser) return <LoginScreen staff={data.staff} onLogin={u => { setAppUser(u); setView('dashboard'); }} onSeed={seedDatabase} isSeeding={seeding} />;

            const hasAccess = (dept) => (appUser.role === 'admin' || (appUser.departments || []).includes(dept));
            const commonProps = { user: appUser, appId, showToast, data, status };

            return (
                <div className="min-h-full bg-slate-50 font-sans text-slate-800">
                    {/* Mobile Header */}
                    <header className="bg-slate-900 text-white py-4 px-5 sticky top-0 z-50 shadow-md flex justify-between items-center pb-[calc(1rem+env(safe-area-inset-top))] pt-[env(safe-area-inset-top)]">
                        <h2 className="font-black text-xl italic tracking-tighter" onClick={()=>setView('dashboard')}>GASTRO<span className="text-indigo-400">.PLATINUM</span></h2>
                        <button onClick={() => setAppUser(null)} className="bg-white/10 p-2 rounded-full text-slate-300 hover:text-white hover:bg-red-600 transition-colors"><LogOut size={18}/></button>
                    </header>

                    {toast && <Toast {...toast} />}
                    
                    <main className="max-w-lg mx-auto p-5 safe-bottom space-y-6">
                        {view === 'dashboard' && <SmartDashboard {...commonProps} setView={setView} hasAccess={hasAccess} />}
                        {view === 'cleaning' && <SmartCleaning {...commonProps} />}
                        {view === 'cooling' && <SmartCooling {...commonProps} />}
                        {view === 'oil' && hasAccess('kitchen') && <SmartFryers {...commonProps} />}
                        {view === 'inventory' && <SmartInventory {...commonProps} />}
                        {view === 'admin' && hasAccess('admin') && <SmartAdmin {...commonProps} />}
                    </main>

                    {/* Mobile Bottom Nav */}
                    <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-md border-t border-slate-100 p-2 pb-[calc(0.5rem+env(safe-area-inset-bottom))] flex justify-around items-end shadow-[0_-4px_10px_rgba(0,0,0,0.03)] z-40">
                        <NavBtn icon={<Menu/>} label="Home" active={view==='dashboard'} onClick={()=>setView('dashboard')}/>
                        <NavBtn icon={<Sparkles/>} label="Putz" active={view==='cleaning'} onClick={()=>setView('cleaning')}/>
                        <NavBtn icon={<Truck/>} label="Lager" active={view==='inventory'} onClick={()=>setView('inventory')}/>
                        {hasAccess('kitchen') && <NavBtn icon={<Droplet/>} label="Öl" active={view==='oil'} onClick={()=>setView('oil')}/>}
                        {hasAccess('admin') && <NavBtn icon={<Settings/>} label="Admin" active={view==='admin'} onClick={()=>setView('admin')}/>}
                    </nav>
                </div>
            );
        }

        // --- 4. AUTH & NAV COMPONENTS ---
        const LoginScreen = ({ staff, onLogin, onSeed, isSeeding }) => (
            <div className="min-h-screen bg-slate-900 flex flex-col justify-center p-6 relative overflow-hidden">
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_right,_#6366f1_0%,_transparent_45%)] opacity-40"></div>
                <div className="z-10 w-full max-w-sm mx-auto">
                    <div className="mb-12">
                        <h1 className="text-5xl font-black text-white mb-2 tracking-tighter italic">GASTRO<span className="text-indigo-400">.APP</span></h1>
                        <p className="text-indigo-200 text-xs font-bold uppercase tracking-[0.3em]">Platinum Mobile</p>
                    </div>
                    <div className="space-y-3">
                        {staff.map(s => (
                            <button key={s.id} onClick={() => onLogin(s)} className="w-full bg-white/10 hover:bg-indigo-600 backdrop-blur-lg border border-white/10 p-4 rounded-2xl text-white flex items-center gap-4 transition-all group active:scale-95">
                                <div className="bg-white/10 p-2.5 rounded-xl"><User size={20} className="text-indigo-300 group-hover:text-white"/></div>
                                <div className="flex-1 text-left">
                                    <div className="font-bold text-lg">{s.name}</div>
                                    <div className="text-[11px] font-medium opacity-60 uppercase">{s.role === 'admin' ? 'Administrator' : (s.departments||[]).join(' • ')}</div>
                                </div>
                                <ChevronDown className="-rotate-90 opacity-50 group-hover:opacity-100 transition-transform group-hover:translate-x-1"/>
                            </button>
                        ))}
                        {/* THE MISSING PIECE: SEED BUTTON */}
                        {staff.length === 0 && (
                            <div className="animate-in text-center">
                                <div className="text-white/50 text-sm mb-4">Datenbank ist leer.</div>
                                <button onClick={onSeed} disabled={isSeeding} className="w-full py-5 border-2 border-dashed border-indigo-500/50 bg-indigo-500/10 text-indigo-300 hover:bg-indigo-500/20 rounded-2xl font-bold uppercase tracking-wider flex justify-center items-center gap-3 transition-all">
                                    {isSeeding ? <Loader2 className="animate-spin"/> : <><Database size={20}/> Ersteinrichtung starten</>}
                                </button>
                                <p className="text-indigo-300/40 text-[10px] mt-2">Erstellt 'Chef' (Admin)</p>
                            </div>
                        )}
                    </div>
                </div>
            </div>
        );

        const NavBtn = ({ icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1.5 px-3 py-2 rounded-2xl transition-all duration-300 ${active ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:text-slate-600'}`}>
                {React.cloneElement(icon, { size: 22, strokeWidth: active ? 2.5 : 2 })}
                <span className="text-[10px] font-bold tracking-tight leading-none">{label}</span>
            </button>
        );

        const DashboardCard = ({ title, sub, icon, color, onClick, badge }) => (
            <button onClick={onClick} className={`relative overflow-hidden w-full text-left p-5 rounded-[2rem] bg-gradient-to-br ${color} text-white shadow-lg shadow-indigo-900/10 active:scale-[0.97] transition-transform`}>
                <div className="absolute right-[-20px] top-[-20px] opacity-20 scale-[1.6] rotate-12 pointer-events-none">{icon}</div>
                <div className="relative z-10 flex flex-col h-full justify-between">
                    <div className="flex justify-between items-start mb-4">
                        <div className="p-3 bg-white/20 rounded-2xl backdrop-blur-sm">{React.cloneElement(icon, { size: 24 })}</div>
                        {badge > 0 && <span className="bg-red-500 text-white text-[11px] font-black px-2.5 py-1 rounded-full shadow-sm">{badge}</span>}
                    </div>
                    <div>
                        <div className="font-black text-xl leading-none mb-1.5">{title}</div>
                        <div className="text-[11px] font-bold uppercase tracking-wider opacity-80">{sub}</div>
                    </div>
                </div>
            </button>
        );

        // --- 5. FEATURE MODULES ---

        // --- DASHBOARD ---
        const SmartDashboard = ({ user, data, status, setView, hasAccess }) => {
            const day = getWeekdayShort();
            const myDepts = user.departments || [];
            const relevantTasks = data.tasks.filter(t => t.schedule?.[day] && (user.role==='admin' || t.dept==='all' || myDepts.includes(t.dept)));
            const doneTasks = relevantTasks.filter(t => status.cleaningLogs[t.id]).length;
            const progress = relevantTasks.length ? Math.round((doneTasks / relevantTasks.length) * 100) : 100;
            const openTemp = data.cooling.filter(d => d.status !== 'defekt').length - status.tempLogs.length;

            return (
                <div className="animate-in space-y-6">
                    <div className="bg-slate-900 text-white p-6 rounded-[2.5rem] shadow-xl flex justify-between items-center relative overflow-hidden">
                        <div className="relative z-10">
                            <div className="text-xs font-bold text-indigo-300 uppercase mb-2">Tagesfortschritt</div>
                            <div className="text-5xl font-black tracking-tighter">{progress}<span className="text-2xl text-indigo-400">%</span></div>
                            <div className="text-sm text-slate-400 font-medium mt-1">{doneTasks} von {relevantTasks.length} Aufgaben erledigt</div>
                        </div>
                         {/* Progress Circle */}
                        <div className="relative w-20 h-20">
                            <svg className="w-full h-full transform -rotate-90">
                                <circle cx="40" cy="40" r="36" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-800" />
                                <circle cx="40" cy="40" r="36" stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={226} strokeDashoffset={226 - (226 * progress) / 100} className="text-indigo-500 transition-all duration-1000 ease-out" strokeLinecap="round" />
                            </svg>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <DashboardCard title="Putzplan" sub="Heute fällig" icon={<Sparkles/>} color="from-indigo-500 to-purple-600" onClick={()=>setView('cleaning')} badge={relevantTasks.length - doneTasks}/>
                        <DashboardCard title="Kühlung" sub="Temperatur" icon={<Snowflake/>} color="from-sky-500 to-blue-600" onClick={()=>setView('cooling')} badge={openTemp}/>
                        {hasAccess('kitchen') && <DashboardCard title="Fett & Öl" sub="Qualität" icon={<Droplet/>} color="from-amber-400 to-orange-500" onClick={()=>setView('oil')} badge={data.fryers.length - Object.keys(status.oilLogs).length}/>}
                        <DashboardCard title="Einkauf" sub="Bestellliste" icon={<Truck/>} color="from-emerald-500 to-teal-600" onClick={()=>setView('inventory')} badge={status.shoppingList.length}/>
                    </div>
                </div>
            );
        };

        // --- CLEANING ---
        const SmartCleaning = ({ data, status, user, appId, showToast }) => {
            const day = getWeekdayShort();
            const myDepts = user.departments || [];
            const relevantTasks = data.tasks.filter(t => t.schedule?.[day] && (user.role==='admin' || t.dept==='all' || myDepts.includes(t.dept)))
                .sort((a,b) => (status.cleaningLogs[a.id]?1:0)-(status.cleaningLogs[b.id]?1:0));
            
            const toggle = async (t) => {
                const logRef = doc(db, 'artifacts', appId, 'public', 'data', 'logs_cleaning', `${getTodayStr()}_${t.id}`);
                if(status.cleaningLogs[t.id]) { 
                    if(user.role==='admin'||status.cleaningLogs[t.id].user===user.name) await deleteDoc(logRef); 
                } else { 
                    await setDoc(logRef,{taskId:t.id,taskName:t.name,user:user.name,dateStr:getTodayStr(),createdAt:serverTimestamp()}); 
                    showToast("Erledigt!", "success");
                }
            };

            return (
                <div className="animate-in"><Header title="Putzplan" sub={day} />
                    <div className="space-y-3">
                        {relevantTasks.map(t=>{
                            const done=status.cleaningLogs[t.id]; 
                            return (
                                <div key={t.id} onClick={()=>toggle(t)} className={`p-4 rounded-2xl border-2 cursor-pointer flex justify-between items-center transition-all active:scale-[0.98] ${done?'bg-slate-50 border-slate-200 opacity-70':'bg-white border-slate-100 hover:border-indigo-200 shadow-sm'}`}>
                                    <div>
                                        <div className={`font-bold text-base ${done?'line-through text-slate-500':''}`}>{t.name}</div>
                                        <div className="text-[11px] uppercase font-bold text-slate-400 mt-1">{t.area}</div>
                                    </div>
                                    {done ? <CheckCircle className="text-emerald-500" size={28}/> : <div className="w-7 h-7 border-2 rounded-xl border-slate-300 bg-slate-50"/>}
                                </div>
                            )
                        })}
                    </div>
                    {relevantTasks.length===0 && <div className="text-center p-10 text-slate-400 border-2 border-dashed rounded-3xl">Alles erledigt!</div>}
                </div>
            );
        };

        // --- COOLING ---
        const SmartCooling = ({ data, status, user, appId, showToast }) => {
            const [inputs, setInputs] = useState({});
            const [loadingId, setLoadingId] = useState(null);
            const activeItems = data.cooling.filter(i => i.status !== 'defekt');

            const save = async (id, name) => {
                const temp = inputs[id];
                if(!temp && temp !== 0) return;
                setLoadingId(id);
                await addDoc(collection(db,'artifacts',appId,'public','data','logs_temp'),{deviceId:id,deviceName:name,temp,user:user.name,dateStr:getTodayStr(),createdAt:serverTimestamp()});
                setLoadingId(null); setInputs(p=>({...p,[id]:''})); showToast(`${name} gespeichert`);
            };

            return (
                <div className="animate-in space-y-4"><Header title="Temperaturen" sub="HACCP Kontrolle" />
                    {activeItems.map(i=>{ 
                        const done = status.tempLogs.find(l=>l.deviceId===i.id);
                        const currentInputStr = inputs[i.id] || '';
                        const tempStatus = getTempStatus(currentInputStr);
                        const statusColors = { neutral: 'text-slate-400', ok: 'text-emerald-500', danger: 'text-red-500' };
                        
                        return (
                        <div key={i.id} className={`p-5 rounded-[1.5rem] border shadow-sm transition-all ${done?'bg-emerald-50/50 border-emerald-200':'bg-white border-slate-100'}`}>
                            <div className="flex justify-between items-center mb-3">
                                <span className="font-bold text-lg">{i.name}</span>
                                {done ? <span className="font-black text-lg text-emerald-600 flex items-center gap-1"><CheckCircle size={16}/>{done.temp}°C</span> 
                                      : <span className="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded-md font-bold uppercase tracking-wider">Messung ausstehend</span>}
                            </div>
                            {!done && (
                                <div className="flex gap-3">
                                    <div className="relative flex-1">
                                        <Input type="number" inputMode="decimal" placeholder="Temperatur..." value={inputs[i.id]||''} onChange={e=>setInputs({...inputs,[i.id]:e.target.value})} className={`pr-10 font-bold text-lg ${tempStatus==='danger'?'text-red-600 border-red-300 bg-red-50 focus:ring-red-200 focus:border-red-500':tempStatus==='ok'?'text-emerald-600 border-emerald-300 bg-emerald-50 focus:ring-emerald-200 focus:border-emerald-500':''}`} />
                                        <Thermometer className={`absolute right-3 top-4 transition-colors ${statusColors[tempStatus]}`} size={20}/>
                                    </div>
                                    <Button onClick={()=>save(i.id, i.name)} isLoading={loadingId===i.id} className="w-auto px-6"><Save size={20}/></Button>
                                </div>
                            )}
                        </div>
                    )})}
                </div>
            );
        };

        // --- INVENTORY ---
        const SmartInventory = ({ status, appId, showToast }) => {
            const [newItem, setNewItem] = useState('');
            const [isAdding, setIsAdding] = useState(false);
            const add = async () => { 
                if(!newItem) return; setIsAdding(true);
                await addDoc(collection(db,'artifacts',appId,'public','data','shopping_list_manual'),{name:newItem, createdAt:serverTimestamp()});
                setNewItem(''); setIsAdding(false); showToast('Artikel hinzugefügt'); 
            };
            const del = async (id) => await deleteDoc(doc(db,'artifacts',appId,'public','data','shopping_list_manual',id));

            return (
                <div className="animate-in space-y-4"><Header title="Einkaufsliste" sub="Manuelle Einträge" />
                    <div className="flex gap-3 p-2 bg-white rounded-2xl border shadow-sm">
                        <Input value={newItem} onChange={e=>setNewItem(e.target.value)} placeholder="Neuer Artikel..." onKeyPress={e=>e.key==='Enter'&&add()} className="border-0 bg-transparent focus:ring-0" />
                        <Button onClick={add} isLoading={isAdding} className="w-auto px-5 rounded-xl"><Plus size={24}/></Button>
                    </div>
                    <div className="bg-white rounded-[1.5rem] border shadow-sm overflow-hidden divide-y divide-slate-100">
                        {status.shoppingList.map(item => (
                            <div key={item.id} className="p-4 flex justify-between items-center group">
                                <div className="font-bold text-slate-800 text-lg">{item.name}</div>
                                <button onClick={()=>del(item.id)} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><X size={20}/></button>
                            </div>
                        ))}
                        {status.shoppingList.length === 0 && <div className="p-6 text-center text-slate-400 font-medium">Liste ist leer.</div>}
                    </div>
                </div>
            );
        };

        // --- FRYERS (OIL) ---
        const SmartFryers = ({ data, status, user, appId, showToast }) => {
            const [vals, setVals] = useState({});
            const [loadingId, setLoadingId] = useState(null);
            const activeItems = data.fryers.filter(i => i.status !== 'defekt');

            const save = async (i) => {
                const t = parseFloat(vals[i.id]?.tmp), p = parseFloat(vals[i.id]?.tpm);
                if(!t || !p) return;
                setLoadingId(i.id);
                await addDoc(collection(db,'artifacts',appId,'public','data','logs_oil'),{deviceId:i.id,deviceName:i.name,temp:t,tpm:p,user:user.name,createdAt:serverTimestamp()});
                setLoadingId(null); showToast("Messung gespeichert");
            };

            const getTpmStatus = (tpm) => {
                if(tpm >= 24) return { bg:'bg-red-500', text:'Wechseln' };
                if(tpm >= 20) return { bg:'bg-amber-500', text:'Filtern' };
                return { bg:'bg-emerald-500', text:'OK' };
            }

            return (
                <div className="animate-in space-y-4"><Header title="Fett & Öl" sub="Qualitätsmessung" />
                    {activeItems.map(i => {
                        const l = status.oilLogs[i.id];
                        const st = l ? getTpmStatus(l.tpm) : null;
                        return (
                            <div key={i.id} className="bg-white p-5 rounded-[1.5rem] border shadow-sm">
                                <div className="flex justify-between items-start mb-4">
                                    <span className="font-bold text-xl text-slate-800">{i.name}</span>
                                    {l && <span className={`${st.bg} text-white text-xs font-black px-3 py-1.5 rounded-full uppercase shadow-sm`}>{st.text}</span>}
                                </div>
                                {!l ? (
                                    <div className="space-y-3">
                                        <div className="flex gap-3">
                                            <Input type="number" inputMode="decimal" placeholder="Temp °C" className="text-center font-bold text-lg" onChange={e=>setVals({...vals,[i.id]:{...vals[i.id],tmp:e.target.value}})}/>
                                            <Input type="number" inputMode="decimal" placeholder="TPM %" className="text-center font-bold text-lg" onChange={e=>setVals({...vals,[i.id]:{...vals[i.id],tpm:e.target.value}})}/>
                                        </div>
                                        <Button onClick={()=>save(i)} isLoading={loadingId===i.id}><Save size={20}/> Speichern</Button>
                                    </div>
                                ) : (
                                    <div className="flex gap-2">
                                        <div className="flex-1 p-3 bg-slate-50 rounded-xl border text-center"><div className="text-xs uppercase text-slate-400 font-bold mb-1">Temp</div><div className="font-mono font-black text-xl">{l.temp}°C</div></div>
                                        <div className="flex-1 p-3 bg-slate-50 rounded-xl border text-center"><div className="text-xs uppercase text-slate-400 font-bold mb-1">TPM</div><div className="font-mono font-black text-xl">{l.tpm}%</div></div>
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- ADMIN ---
        const SmartAdmin = ({ data, appId, showToast }) => {
            const [tab, setTab] = useState('staff'); 
            const [editingItem, setEditingItem] = useState(null);
            const tabs = { staff: 'Personal', tasks: 'Putzplan', cooling: 'Kühlgeräte', fryers: 'Fritteusen' };

            const deleteItem = async (id) => {
                if(!window.confirm("Wirklich löschen?")) return;
                const colMap = { tasks:'cleaning_tasks', cooling:'cooling_devices', fryers:'fryers', staff:'staff' };
                await deleteDoc(doc(db,'artifacts',appId,'public','data',colMap[tab], id));
                showToast("Gelöscht");
            };

            return (
                <div className="animate-in pb-10 space-y-4">
                    <Header title="Verwaltung" sub="Setup" />
                    <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar -mx-5 px-5">
                        {Object.entries(tabs).map(([k,label])=>(
                            <button key={k} onClick={()=>{setTab(k);setEditingItem(null)}} className={`px-5 py-2.5 rounded-full text-sm font-bold whitespace-nowrap transition-all ${tab===k?'bg-slate-900 text-white shadow-md':'bg-white text-slate-500 border'}`}>{label}</button>
                        ))}
                    </div>
                    
                    <div className="bg-white rounded-[1.5rem] border shadow-sm p-5 min-h-[300px]">
                        {editingItem ? (
                            <EditorForm type={tab} initialData={editingItem} onClose={()=>setEditingItem(null)} appId={appId} showToast={showToast} />
                        ) : (
                            <div className="space-y-4">
                                <Button variant="ghost" onClick={()=>setEditingItem({isNew:true})} className="border-dashed text-slate-400 py-4"><Plus size={22}/> Neuen Eintrag anlegen</Button>
                                <div className="divide-y divide-slate-100">
                                    {(data[tab]||[]).map(item=>(
                                        <div key={item.id} className="py-4 flex justify-between items-center">
                                            <div>
                                                <div className="font-bold text-lg text-slate-800">{item.name}</div>
                                                <div className="text-xs font-medium text-slate-400 flex flex-wrap gap-2 mt-1">
                                                    {item.status==='defekt' && <span className="bg-red-100 text-red-600 px-2 py-0.5 rounded-md font-bold uppercase text-[10px]">Defekt</span>}
                                                    {tab==='staff' && (item.role==='admin'?'Admin':(item.departments||[]).join(', '))}
                                                    {tab==='tasks' && `${item.area} (${item.dept})`}
                                                </div>
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={()=>setEditingItem(item)} className="p-2.5 bg-indigo-50 text-indigo-600 rounded-xl"><Edit3 size={18}/></button>
                                                <button onClick={()=>deleteItem(item.id)} className="p-2.5 bg-red-50 text-red-600 rounded-xl"><Trash2 size={18}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EditorForm = ({ type, initialData, onClose, appId, showToast }) => {
            const [form, setForm] = useState({ name: '', ...initialData });
            const [saving, setSaving] = useState(false);
            const [schedule, setSchedule] = useState(initialData.schedule || { Mo:true, Di:true, Mi:true, Do:true, Fr:true, Sa:true, So:true });
            const [depts, setDepts] = useState(initialData.departments || []);

            const update = (f, v) => setForm(p => ({ ...p, [f]: v }));
            const toggleDept = (d) => setDepts(prev => prev.includes(d) ? prev.filter(x=>x!==d) : [...prev,d]);

            const save = async () => {
                if(!form.name) return showToast("Name fehlt", "error");
                setSaving(true);
                const colMap = { tasks:'cleaning_tasks', cooling:'cooling_devices', fryers:'fryers', staff:'staff' };
                const payload = { ...form, name: form.name };
                
                if(type === 'tasks') { payload.schedule = schedule; payload.area = form.area || 'Allgemein'; payload.dept = form.dept || 'kitchen'; }
                if(type === 'staff') { payload.role = form.role || 'user'; payload.departments = depts; payload.pin = form.pin || '0000'; }
                if(['cooling','fryers'].includes(type)) { payload.status = form.status || 'active'; }

                delete payload.isNew; delete payload.id;
                try {
                    if(initialData.isNew) { await addDoc(collection(db,'artifacts',appId,'public','data',colMap[type]), {...payload, createdAt: serverTimestamp()}); } 
                    else { await updateDoc(doc(db,'artifacts',appId,'public','data',colMap[type], initialData.id), payload); }
                    showToast("Gespeichert"); onClose();
                } catch(e) { showToast("Fehler beim Speichern", "error"); console.error(e); }
                setSaving(false);
            };

            const Label = ({c}) => <label className="block text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">{c}</label>;

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center mb-4"><h3 className="font-black text-xl">{initialData.isNew?'Neu erstellen':'Bearbeiten'}</h3><button onClick={onClose} className="p-2 bg-slate-100 rounded-full"><X size={20}/></button></div>
                    
                    <div><Label c="Name"/><Input value={form.name} onChange={e=>update('name',e.target.value)} placeholder="Bezeichnung eingeben" /></div>
                    
                    {['cooling','fryers'].includes(type) && (
                        <div><Label c="Status"/><Select value={form.status||'active'} onChange={e=>update('status',e.target.value)}><option value="active">Aktiv (In Betrieb)</option><option value="defekt">Defekt / In Wartung</option></Select></div>
                    )}

                    {type === 'staff' && (
                        <div className="space-y-5">
                             <div><Label c="Bereiche"/><div className="flex gap-3"><button onClick={()=>toggleDept('kitchen')} className={`flex-1 py-4 rounded-xl border-2 font-bold flex items-center justify-center gap-2 transition-all ${depts.includes('kitchen')?'bg-orange-50 border-orange-400 text-orange-700':'bg-white border-slate-200 text-slate-400'}`}><ChefHat size={22}/> Küche</button><button onClick={()=>toggleDept('service')} className={`flex-1 py-4 rounded-xl border-2 font-bold flex items-center justify-center gap-2 transition-all ${depts.includes('service')?'bg-purple-50 border-purple-400 text-purple-700':'bg-white border-slate-200 text-slate-400'}`}><Coffee size={22}/> Service</button></div></div>
                             <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><Label c="Rolle"/><Select value={form.role||'user'} onChange={e=>update('role',e.target.value)}><option value="user">Mitarbeiter</option><option value="admin">Administrator</option></Select></div><div><Label c="PIN Code (4-stellig)"/><Input inputMode="numeric" maxLength={4} value={form.pin||''} onChange={e=>update('pin',e.target.value)} placeholder="0000" className="text-center font-mono tracking-[0.5em] text-xl"/></div></div>
                        </div>
                    )}

                    {type === 'tasks' && (
                        <div className="space-y-5">
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><Label c="Zuständigkeit"/><Select value={form.dept||'kitchen'} onChange={e=>update('dept',e.target.value)}><option value="kitchen">Küche</option><option value="service">Service</option><option value="all">Alle</option></Select></div><div><Label c="Bereich / Ort"/><Input value={form.area||''} onChange={e=>update('area',e.target.value)} placeholder="z.B. Bar, Lager..." /></div></div>
                            <div className="bg-slate-50 p-4 rounded-2xl border"><Label c="Wochentage"/><div className="flex justify-between gap-1 mt-3">{['Mo','Di','Mi','Do','Fr','Sa','So'].map(d => (<button key={d} onClick={()=>setSchedule(s=>({...s,[d]:!s[d]}))} className={`flex-1 h-14 rounded-xl flex flex-col items-center justify-center border-2 transition-all active:scale-95 ${schedule[d]?'bg-indigo-600 border-indigo-600 text-white shadow-md':'bg-white border-slate-200 text-slate-400'}`}><span className="text-xs font-black uppercase leading-none mb-1">{d}</span>{schedule[d] && <CheckSquare size={14}/>}</button>))}</div></div>
                        </div>
                    )}
                    <Button onClick={save} isLoading={saving} className="mt-8 py-4 text-base">Speichern</Button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
